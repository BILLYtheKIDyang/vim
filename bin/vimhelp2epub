#!/bin/sh
rm -rf *.epub
rm -rf tmp
mkdir -p tmp
cd tmp
mkdir -p META-INF
mkdir -p OEBPS
echo "application/epub+zip" > mimetype
echo "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>" > META-INF/container.xml
echo "<container xmlns=\"urn:oasis:names:tc:opendocument:xmlns:container\" version=\"1.0\"><rootfiles><rootfile full-path=\"OEBPS/package.opf\" media-type=\"application/oebps-package+xml\"/></rootfiles></container>" >> META-INF/container.xml
cd OEBPS
perl ~/.vim/bin/vim2html.pl "$1"/tags "$1"/*.txt

mkdir -p tmp
sed 's/["#]/\n/g' help.html | awk '/\.html$$/ {if(!($$1 in lut)) print $$1; lut[$$1]++}' > tmp/help.list
#ls -1 *.html | sort > tmp/html.list
echo "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>" > toc.ncx
echo "<ncx xmlns=\"http://www.daisy.org/z3986/2005/ncx/\" version=\"2005-1\">" >> toc.ncx
echo "   <head>" >> toc.ncx
echo "      <meta name=\"dtb:uid\" content=\"_book\"/>" >> toc.ncx
echo "   </head>" >> toc.ncx
echo "   <docTitle>" >> toc.ncx
echo "      <text>The Kawa Scheme language</text>" >> toc.ncx
echo "   </docTitle>" >> toc.ncx
echo "<navMap>" >> toc.ncx
cat tmp/help.list| awk '{printf ("<navPoint id=\"%s\" playOrder=\"%s\"><navLabel><text>%s</text></navLabel><content src=\"%s\"/></navPoint>\n", $$1, NR, $$1 ,$$1) }' >> toc.ncx

echo "</navMap>" >> toc.ncx
echo "</ncx>" >> toc.ncx

echo "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?>">package.opf
echo "<package xmlns=\"http://www.idpf.org/2007/opf\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns:dcterms=\"http://purl.org/dc/terms/\" version=\"3.0\" xml:lang=\"en\" unique-identifier=\"pub-identifier\">">>package.opf
echo "  <metadata>">>package.opf
echo "    <dc:identifier id=\"pub-identifier\">_book</dc:identifier>">>package.opf
echo "    <meta id=\"meta-identifier\" property=\"dcterms:identifier\">_book</meta>">>package.opf
echo "    <dc:title id=\"pub-title\">The Kawa Scheme language</dc:title>">>package.opf
echo "    <meta property=\"dcterms:title\" id=\"meta-title\">The Kawa Scheme language</meta>">>package.opf
echo "    <dc:language id=\"pub-language\">en</dc:language>">>package.opf
echo "    <meta property=\"dcterms:language\" id=\"meta-language\">en</meta>">>package.opf
echo "    <meta property=\"dcterms:modified\">2017-10-02T06:22:07Z</meta>">>package.opf
echo "  </metadata>">>package.opf

echo "<manifest>" >> package.opf
echo "<item id=\"ncx\" href=\"toc.ncx\" media-type=\"application/x-dtbncx+xml\"/>" >> package.opf 
cat tmp/help.list | awk '{printf "<item id=\"%s\" href=\"%s\" media-type=\"application/xhtml+xml\"/>\n",$$1,$$1}' >> package.opf
echo "</manifest>" >> package.opf
echo "<spine toc=\"ncx\">" >> package.opf
cat tmp/help.list | awk '{printf "<itemref idref=\"%s\"/>\n",$$1}' >> package.opf
echo "</spine>" >> package.opf

echo "<guide>" >> package.opf
echo "<reference type=\"toc\" title=\"Table of Contents\" href=\"usr_toc.html\"/>" >> package.opf
echo "<reference type=\"toc\" title=\"Beginning\" href=\"help.html\"/>" >> package.opf
echo "</guide>" >> package.opf
echo "" >> package.opf
echo "</package>" >> package.opf
#rm -rf tmp
cd ..
zip -r ../"$2".epub .
